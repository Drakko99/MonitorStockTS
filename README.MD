# MonitorStockTS

Script sencillo en **TypeScript** para **vigilar el stock de un producto a partir de su URL**.  
Cada cierto tiempo descarga la p√°gina, analiza su contenido y busca frases configurables que indiquen:

- que **NO** hay stock (por ejemplo: `agotado`, `sin stock`, `no disponible`), o  
- que **S√ç** hay stock (por ejemplo: `en stock`, `disponible`, `Add to cart`).

Cuando detecta un cambio de estado **de sin stock ‚ûú a en stock**, muestra una notificaci√≥n por consola.

---

## üß© Caracter√≠sticas principales

- ‚úÖ Escrito en **TypeScript** para **Node.js** (CommonJS).
- üîÅ Comprueba el stock cada **X minutos**, configurable desde `.env`.
- üß† Detecci√≥n basada en **patrones de texto** (listas de frases configurables).
- üåê Scraping adaptado a distintos tipos de sitios:
  - **HTML est√°tico**: utiliza `axios` + `cheerio` para la mayor√≠a de webs.
  - **AliExpress**: usa **Playwright (Chromium headless)** para cargar la p√°gina completa.
  - **Amazon**: intenta leer espec√≠ficamente la secci√≥n de disponibilidad.
- üîî Solo notifica cuando hay un cambio de **SIN stock ‚ûú EN stock** para evitar spam.
- üõ† Arquitectura pensada para extender el sistema de notificaciones  
  (email, Telegram, Discord, push, etc., cambiando solo un archivo).

---

## üì¶ Requisitos

- **Node.js** ‚â• 18 (recomendado LTS).
- **npm** (o gestor compatible).
- Dependencias del sistema necesarias para que **Playwright** pueda lanzar Chromium.  
  - En Linux puede requerir librer√≠as adicionales.  
  - En Windows y macOS suele funcionar sin configuraci√≥n extra.

---

## üöÄ Instalaci√≥n

1. Clona el repositorio y entra en la carpeta:

   ```bash
   git clone https://github.com/Drakko99/MonitorStockTS
   cd MonitorStockTS
   ```

2. Instala las dependencias:

   ```bash
   npm install
   ```

---

## ‚öôÔ∏è Configuraci√≥n

Copia el archivo de ejemplo `.env.example` y ren√≥mbralo a `.env`:

```bash
cp .env.example .env
```

Edita el archivo `.env` con los valores que quieras:

```dotenv
# URL del producto a vigilar
PRODUCT_URL=https://ejemplo.com/mi-producto

# Cada cu√°ntos minutos comprobar (entero)
CHECK_INTERVAL_MINUTES=60

# Palabras/frases que indican que NO hay stock (separadas por comas)
OUT_OF_STOCK_PATTERNS=agotado,sin stock,no disponible,Out of stock, Get notified by e-mail on stock availability

# Palabras/frases que indican que S√ç hay stock (separadas por comas)
IN_STOCK_PATTERNS=en stock,disponible,Add to cart,In stock, Comprar ya, Comprar, Agregar al carrito
```

### Variables disponibles

| Variable                 | Obligatoria | Por defecto                       | Descripci√≥n                                                              |
| ------------------------ | ----------: | --------------------------------- | ------------------------------------------------------------------------ |
| `PRODUCT_URL`            |           ‚úÖ | *(ninguno)*                       | URL del producto a monitorizar.                                          |
| `CHECK_INTERVAL_MINUTES` |           ‚ùå | `5`                               | Intervalo en minutos entre comprobaciones. Debe ser un entero > 0.       |
| `OUT_OF_STOCK_PATTERNS`  |           ‚ùå | `agotado,sin stock,no disponible` | Frases que indican que **no** hay stock (separadas por comas).           |
| `IN_STOCK_PATTERNS`      |           ‚ùå | `en stock,disponible`             | Frases que indican que **s√≠** hay stock (separadas por comas).           |

> Todos los patrones se convierten internamente a min√∫sculas y se buscan como **subcadenas** dentro del texto de la p√°gina.

---

## ‚ñ∂Ô∏è Ejecuci√≥n

### Modo desarrollo (TypeScript directamente)

Para ejecutar el script sin compilar, usando `ts-node`:

```bash
npm run dev
```

### Modo producci√≥n (JavaScript compilado)

1. Compila el proyecto:

   ```bash
   npm run build
   ```

2. Ejecuta el c√≥digo compilado:

   ```bash
   npm start
   ```

---

## üìù Ejemplo de uso

### 1. Configura la URL y los patrones

Por ejemplo, para vigilar un producto en una tienda online:

```dotenv
PRODUCT_URL=https://tienda-ejemplo.com/producto/abc123
CHECK_INTERVAL_MINUTES=15
OUT_OF_STOCK_PATTERNS=agotado,sin stock,no disponible,Out of stock
IN_STOCK_PATTERNS=en stock,disponible,Add to cart
```

Despu√©s:

```bash
npm install
npm run dev
```

### 2. Ejemplo de salida en consola

Al iniciar, ver√°s algo similar a:

```text
========================================
 Iniciando stock-watcher
========================================
Producto: https://tienda-ejemplo.com/producto/abc123
Intervalo: 15 minuto(s)
Patrones SIN stock: agotado, sin stock, no disponible, out of stock
Patrones CON stock: en stock, disponible, add to cart
========================================

[14/11/2025 10:00:00] Comprobando stock...
Patrones SIN stock encontrados: [ 'sin stock' ]
Patrones CON stock encontrados: []
Resultado: SIN STOCK ‚ùå
```

Cuando el producto pase a estar disponible en una comprobaci√≥n posterior:

```text
[14/11/2025 10:15:00] Comprobando stock...
Patrones SIN stock encontrados: []
Patrones CON stock encontrados: [ 'en stock', 'add to cart' ]
Resultado: EN STOCK ‚úÖ
========================================
üéâ ¬°EL PRODUCTO HA VUELTO A ESTAR EN STOCK!
URL: https://tienda-ejemplo.com/producto/abc123
Hora: 14/11/2025 10:15:02
========================================
```

El mensaje de celebraci√≥n se muestra **solo cuando se detecta un cambio** de  
‚Äúantes sin stock‚Äù ‚ûú ‚Äúahora en stock‚Äù.

---

## üß± Arquitectura interna (resumen)

1. **Configuraci√≥n** ‚Äì `src/config.ts`  
   - Carga las variables de entorno desde `.env` usando `dotenv`.
   - Valida que `PRODUCT_URL` exista y que `CHECK_INTERVAL_MINUTES` sea un entero > 0.
   - Convierte `OUT_OF_STOCK_PATTERNS` e `IN_STOCK_PATTERNS` en arrays normalizados (min√∫sculas).

2. **Scraping** ‚Äì `src/scraper.ts`  
   - Si la URL contiene `aliexpress.com`, usa **Playwright** (Chromium headless) para cargar la p√°gina completa y extraer el texto del `<body>`.
   - Si no es AliExpress:
     - Usa `axios` para hacer el `GET` de la p√°gina.
     - Usa `cheerio` para parsear el HTML.
     - Si la URL es de **Amazon**, intenta leer elementos t√≠picos de disponibilidad (`#availability`, etc.).
     - En otros casos, toma el texto completo del `<body>`.
   - Normaliza el texto (min√∫sculas, espacios).
   - Busca coincidencias de patrones de **SIN stock** y **CON stock** y aplica la l√≥gica:
     - Sin coincidencias ‚ûú se asume **SIN stock** (enfoque conservador).
     - Solo patrones de SIN stock ‚ûú **SIN stock**.
     - Solo patrones de CON stock ‚ûú **EN stock**.
     - Ambos tipos a la vez ‚ûú prevalece **SIN stock**.

3. **Bucle de comprobaci√≥n** ‚Äì `src/index.ts`  
   - Muestra por consola la configuraci√≥n inicial.
   - Ejecuta una primera comprobaci√≥n inmediata.
   - Configura un `setInterval` para repetir la comprobaci√≥n cada `CHECK_INTERVAL_MINUTES`.
   - Guarda el √∫ltimo estado y compara:
     - Si antes no hab√≠a stock y ahora s√≠ ‚ûú llama a `notifyInStock`.

4. **Notificaci√≥n** ‚Äì `src/notifier.ts`  
   - Actualmente, simplemente imprime un mensaje por consola indicando que el producto ha vuelto a estar en stock.
   - Es el punto de extensi√≥n ideal para integrar:
     - Env√≠o de emails.
     - Mensajes a Telegram/Discord.
     - Notificaciones push, etc.

---

## üîî Personalizaci√≥n de notificaciones

La funci√≥n que se encarga de avisar cuando hay stock es:

```ts
// src/notifier.ts
export async function notifyInStock(config: AppConfig, result: CheckResult): Promise<void> {
  console.log("========================================");
  console.log("üéâ ¬°EL PRODUCTO HA VUELTO A ESTAR EN STOCK!");
  console.log(`URL: ${config.productUrl}`);
  console.log(`Hora: ${result.checkedAt.toLocaleString()}`);
  console.log("========================================");
}

## ‚ö†Ô∏è Limitaciones y buenas pr√°cticas

- Evita intervalos de comprobaci√≥n demasiado bajos  
  (por ejemplo, cada pocos segundos) para no abusar del servidor.
- P√°ginas con **CAPTCHA**, protecciones anti-bot o restricciones regionales pueden no funcionar correctamente.

---